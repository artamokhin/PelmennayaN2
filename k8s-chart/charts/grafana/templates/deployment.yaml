apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
        supplementalGroups:
          - 0
      containers:
        - name: grafana
          image: grafana/grafana:8.4.4
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
              name: http-grafana
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /robots.txt
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 2
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 3000
            timeoutSeconds: 1
          resources:
{{ toYaml .Values.resources | indent 12}}
          args:
            - "--admin-password=$GrafanaPass"
          volumeMounts:
            - mountPath: /var/lib/grafana
              name: grafana-pv
      volumes:
        - name: grafana-pv
          persistentVolumeClaim:
            claimName: grafana-pvc
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: {{ .Release.Namespace }}
data:
  default-dashboard.json: |
    ewogICJhbm5vdGF0aW9ucyI6IHsKICAgICJsaXN0IjogWwogICAgICB7CiAgICAgICAgImJ1aWx0SW4iOiAxLAogICAgICAgICJkYXRhc291cmNlIjogIi0tIEdyYWZhbmEgLS0iLAogICAgICAgICJlbmFibGUiOiB0cnVlLAogICAgICAgICJoaWRlIjogdHJ1ZSwKICAgICAgICAiaWNvbkNvbG9yIjogInJnYmEoMCwgMjExLCAyNTUsIDEpIiwKICAgICAgICAibmFtZSI6ICJBbm5vdGF0aW9ucyAmIEFsZXJ0cyIsCiAgICAgICAgInRhcmdldCI6IHsKICAgICAgICAgICJsaW1pdCI6IDEwMCwKICAgICAgICAgICJtYXRjaEFueSI6IGZhbHNlLAogICAgICAgICAgInRhZ3MiOiBbXSwKICAgICAgICAgICJ0eXBlIjogImRhc2hib2FyZCIKICAgICAgICB9LAogICAgICAgICJ0eXBlIjogImRhc2hib2FyZCIKICAgICAgfQogICAgXQogIH0sCiAgImVkaXRhYmxlIjogdHJ1ZSwKICAiZmlzY2FsWWVhclN0YXJ0TW9udGgiOiAwLAogICJncmFwaFRvb2x0aXAiOiAwLAogICJpZCI6IDEsCiAgImxpbmtzIjogWwogICAgewogICAgICAiYXNEcm9wZG93biI6IGZhbHNlLAogICAgICAiaWNvbiI6ICJleHRlcm5hbCBsaW5rIiwKICAgICAgImluY2x1ZGVWYXJzIjogZmFsc2UsCiAgICAgICJrZWVwVGltZSI6IGZhbHNlLAogICAgICAidGFncyI6IFtdLAogICAgICAidGFyZ2V0QmxhbmsiOiBmYWxzZSwKICAgICAgInRpdGxlIjogIk5ldyBsaW5rIiwKICAgICAgInRvb2x0aXAiOiAiIiwKICAgICAgInR5cGUiOiAiZGFzaGJvYXJkcyIsCiAgICAgICJ1cmwiOiAiIgogICAgfQogIF0sCiAgImxpdmVOb3ciOiBmYWxzZSwKICAicGFuZWxzIjogWwogICAgewogICAgICAiZmllbGRDb25maWciOiB7CiAgICAgICAgImRlZmF1bHRzIjogewogICAgICAgICAgImNvbG9yIjogewogICAgICAgICAgICAibW9kZSI6ICJwYWxldHRlLWNsYXNzaWMiCiAgICAgICAgICB9LAogICAgICAgICAgImN1c3RvbSI6IHsKICAgICAgICAgICAgImF4aXNMYWJlbCI6ICIiLAogICAgICAgICAgICAiYXhpc1BsYWNlbWVudCI6ICJhdXRvIiwKICAgICAgICAgICAgImJhckFsaWdubWVudCI6IDAsCiAgICAgICAgICAgICJkcmF3U3R5bGUiOiAibGluZSIsCiAgICAgICAgICAgICJmaWxsT3BhY2l0eSI6IDAsCiAgICAgICAgICAgICJncmFkaWVudE1vZGUiOiAibm9uZSIsCiAgICAgICAgICAgICJoaWRlRnJvbSI6IHsKICAgICAgICAgICAgICAibGVnZW5kIjogZmFsc2UsCiAgICAgICAgICAgICAgInRvb2x0aXAiOiBmYWxzZSwKICAgICAgICAgICAgICAidml6IjogZmFsc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImxpbmVJbnRlcnBvbGF0aW9uIjogImxpbmVhciIsCiAgICAgICAgICAgICJsaW5lV2lkdGgiOiAxLAogICAgICAgICAgICAicG9pbnRTaXplIjogNSwKICAgICAgICAgICAgInNjYWxlRGlzdHJpYnV0aW9uIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpbmVhciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInNob3dQb2ludHMiOiAiYXV0byIsCiAgICAgICAgICAgICJzcGFuTnVsbHMiOiBmYWxzZSwKICAgICAgICAgICAgInN0YWNraW5nIjogewogICAgICAgICAgICAgICJncm91cCI6ICJBIiwKICAgICAgICAgICAgICAibW9kZSI6ICJub25lIgogICAgICAgICAgICB9LAogICAgICAgICAgICAidGhyZXNob2xkc1N0eWxlIjogewogICAgICAgICAgICAgICJtb2RlIjogIm9mZiIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJtYXBwaW5ncyI6IFtdLAogICAgICAgICAgInRocmVzaG9sZHMiOiB7CiAgICAgICAgICAgICJtb2RlIjogImFic29sdXRlIiwKICAgICAgICAgICAgInN0ZXBzIjogWwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJjb2xvciI6ICJncmVlbiIsCiAgICAgICAgICAgICAgICAidmFsdWUiOiBudWxsCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAiY29sb3IiOiAicmVkIiwKICAgICAgICAgICAgICAgICJ2YWx1ZSI6IDgwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgInVuaXQiOiAicyIKICAgICAgICB9LAogICAgICAgICJvdmVycmlkZXMiOiBbXQogICAgICB9LAogICAgICAiZ3JpZFBvcyI6IHsKICAgICAgICAiaCI6IDgsCiAgICAgICAgInciOiAxMiwKICAgICAgICAieCI6IDAsCiAgICAgICAgInkiOiAwCiAgICAgIH0sCiAgICAgICJpZCI6IDQsCiAgICAgICJvcHRpb25zIjogewogICAgICAgICJsZWdlbmQiOiB7CiAgICAgICAgICAiY2FsY3MiOiBbXSwKICAgICAgICAgICJkaXNwbGF5TW9kZSI6ICJsaXN0IiwKICAgICAgICAgICJwbGFjZW1lbnQiOiAiYm90dG9tIgogICAgICAgIH0sCiAgICAgICAgInRvb2x0aXAiOiB7CiAgICAgICAgICAibW9kZSI6ICJzaW5nbGUiLAogICAgICAgICAgInNvcnQiOiAibm9uZSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJ0YXJnZXRzIjogWwogICAgICAgIHsKICAgICAgICAgICJkYXRhc291cmNlIjogewogICAgICAgICAgICAidHlwZSI6ICJwcm9tZXRoZXVzIiwKICAgICAgICAgICAgInVpZCI6ICJjOTd2QWRVVnoiCiAgICAgICAgICB9LAogICAgICAgICAgImV4ZW1wbGFyIjogdHJ1ZSwKICAgICAgICAgICJleHByIjogInJhdGUocmVzcG9uc2VfdGltaW5nX21zX2NvdW50e31bMW1dKSIsCiAgICAgICAgICAiaW50ZXJ2YWwiOiAiIiwKICAgICAgICAgICJsZWdlbmRGb3JtYXQiOiAiIiwKICAgICAgICAgICJyZWZJZCI6ICJBIgogICAgICAgIH0KICAgICAgXSwKICAgICAgInRpdGxlIjogItCX0LDQtNC10YDQttC60LAg0Log0LHRjdC60LXQvdC00YMiLAogICAgICAidHlwZSI6ICJ0aW1lc2VyaWVzIgogICAgfSwKICAgIHsKICAgICAgImZpZWxkQ29uZmlnIjogewogICAgICAgICJkZWZhdWx0cyI6IHsKICAgICAgICAgICJjb2xvciI6IHsKICAgICAgICAgICAgIm1vZGUiOiAicGFsZXR0ZS1jbGFzc2ljIgogICAgICAgICAgfSwKICAgICAgICAgICJjdXN0b20iOiB7CiAgICAgICAgICAgICJheGlzTGFiZWwiOiAiIiwKICAgICAgICAgICAgImF4aXNQbGFjZW1lbnQiOiAiYXV0byIsCiAgICAgICAgICAgICJiYXJBbGlnbm1lbnQiOiAwLAogICAgICAgICAgICAiZHJhd1N0eWxlIjogImxpbmUiLAogICAgICAgICAgICAiZmlsbE9wYWNpdHkiOiAwLAogICAgICAgICAgICAiZ3JhZGllbnRNb2RlIjogIm5vbmUiLAogICAgICAgICAgICAiaGlkZUZyb20iOiB7CiAgICAgICAgICAgICAgImxlZ2VuZCI6IGZhbHNlLAogICAgICAgICAgICAgICJ0b29sdGlwIjogZmFsc2UsCiAgICAgICAgICAgICAgInZpeiI6IGZhbHNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJsaW5lSW50ZXJwb2xhdGlvbiI6ICJsaW5lYXIiLAogICAgICAgICAgICAibGluZVdpZHRoIjogMSwKICAgICAgICAgICAgInBvaW50U2l6ZSI6IDUsCiAgICAgICAgICAgICJzY2FsZURpc3RyaWJ1dGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaW5lYXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzaG93UG9pbnRzIjogImF1dG8iLAogICAgICAgICAgICAic3Bhbk51bGxzIjogZmFsc2UsCiAgICAgICAgICAgICJzdGFja2luZyI6IHsKICAgICAgICAgICAgICAiZ3JvdXAiOiAiQSIsCiAgICAgICAgICAgICAgIm1vZGUiOiAibm9uZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInRocmVzaG9sZHNTdHlsZSI6IHsKICAgICAgICAgICAgICAibW9kZSI6ICJvZmYiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAibWFwcGluZ3MiOiBbXSwKICAgICAgICAgICJ0aHJlc2hvbGRzIjogewogICAgICAgICAgICAibW9kZSI6ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICJzdGVwcyI6IFsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAiY29sb3IiOiAiZ3JlZW4iLAogICAgICAgICAgICAgICAgInZhbHVlIjogbnVsbAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImNvbG9yIjogInJlZCIsCiAgICAgICAgICAgICAgICAidmFsdWUiOiA4MAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm92ZXJyaWRlcyI6IFtdCiAgICAgIH0sCiAgICAgICJncmlkUG9zIjogewogICAgICAgICJoIjogOCwKICAgICAgICAidyI6IDExLAogICAgICAgICJ4IjogMTIsCiAgICAgICAgInkiOiAwCiAgICAgIH0sCiAgICAgICJpZCI6IDYsCiAgICAgICJvcHRpb25zIjogewogICAgICAgICJsZWdlbmQiOiB7CiAgICAgICAgICAiY2FsY3MiOiBbXSwKICAgICAgICAgICJkaXNwbGF5TW9kZSI6ICJsaXN0IiwKICAgICAgICAgICJwbGFjZW1lbnQiOiAiYm90dG9tIgogICAgICAgIH0sCiAgICAgICAgInRvb2x0aXAiOiB7CiAgICAgICAgICAibW9kZSI6ICJzaW5nbGUiLAogICAgICAgICAgInNvcnQiOiAibm9uZSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJ0YXJnZXRzIjogWwogICAgICAgIHsKICAgICAgICAgICJkYXRhc291cmNlIjogewogICAgICAgICAgICAidHlwZSI6ICJwcm9tZXRoZXVzIiwKICAgICAgICAgICAgInVpZCI6ICJjOTd2QWRVVnoiCiAgICAgICAgICB9LAogICAgICAgICAgImV4ZW1wbGFyIjogdHJ1ZSwKICAgICAgICAgICJleHByIjogInVwe30iLAogICAgICAgICAgImludGVydmFsIjogIiIsCiAgICAgICAgICAibGVnZW5kRm9ybWF0IjogIiIsCiAgICAgICAgICAicmVmSWQiOiAiQSIKICAgICAgICB9CiAgICAgIF0sCiAgICAgICJ0aXRsZSI6ICLQlNC+0YHRgtGD0L/QvdC+0YHRgtGMINCx0Y3QutC10L3QtNCwIiwKICAgICAgInR5cGUiOiAidGltZXNlcmllcyIKICAgIH0sCiAgICB7CiAgICAgICJmaWVsZENvbmZpZyI6IHsKICAgICAgICAiZGVmYXVsdHMiOiB7CiAgICAgICAgICAiY29sb3IiOiB7CiAgICAgICAgICAgICJtb2RlIjogInBhbGV0dGUtY2xhc3NpYyIKICAgICAgICAgIH0sCiAgICAgICAgICAiY3VzdG9tIjogewogICAgICAgICAgICAiYXhpc0xhYmVsIjogIiIsCiAgICAgICAgICAgICJheGlzUGxhY2VtZW50IjogImF1dG8iLAogICAgICAgICAgICAiYmFyQWxpZ25tZW50IjogMCwKICAgICAgICAgICAgImRyYXdTdHlsZSI6ICJsaW5lIiwKICAgICAgICAgICAgImZpbGxPcGFjaXR5IjogMCwKICAgICAgICAgICAgImdyYWRpZW50TW9kZSI6ICJub25lIiwKICAgICAgICAgICAgImhpZGVGcm9tIjogewogICAgICAgICAgICAgICJsZWdlbmQiOiBmYWxzZSwKICAgICAgICAgICAgICAidG9vbHRpcCI6IGZhbHNlLAogICAgICAgICAgICAgICJ2aXoiOiBmYWxzZQogICAgICAgICAgICB9LAogICAgICAgICAgICAibGluZUludGVycG9sYXRpb24iOiAibGluZWFyIiwKICAgICAgICAgICAgImxpbmVXaWR0aCI6IDEsCiAgICAgICAgICAgICJwb2ludFNpemUiOiA1LAogICAgICAgICAgICAic2NhbGVEaXN0cmlidXRpb24iOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGluZWFyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic2hvd1BvaW50cyI6ICJhdXRvIiwKICAgICAgICAgICAgInNwYW5OdWxscyI6IGZhbHNlLAogICAgICAgICAgICAic3RhY2tpbmciOiB7CiAgICAgICAgICAgICAgImdyb3VwIjogIkEiLAogICAgICAgICAgICAgICJtb2RlIjogIm5vbmUiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ0aHJlc2hvbGRzU3R5bGUiOiB7CiAgICAgICAgICAgICAgIm1vZGUiOiAib2ZmIgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIm1hcHBpbmdzIjogW10sCiAgICAgICAgICAidGhyZXNob2xkcyI6IHsKICAgICAgICAgICAgIm1vZGUiOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAic3RlcHMiOiBbCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImNvbG9yIjogImdyZWVuIiwKICAgICAgICAgICAgICAgICJ2YWx1ZSI6IG51bGwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJjb2xvciI6ICJyZWQiLAogICAgICAgICAgICAgICAgInZhbHVlIjogODAKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdmVycmlkZXMiOiBbXQogICAgICB9LAogICAgICAiZ3JpZFBvcyI6IHsKICAgICAgICAiaCI6IDksCiAgICAgICAgInciOiAxMiwKICAgICAgICAieCI6IDAsCiAgICAgICAgInkiOiA4CiAgICAgIH0sCiAgICAgICJpZCI6IDIsCiAgICAgICJvcHRpb25zIjogewogICAgICAgICJsZWdlbmQiOiB7CiAgICAgICAgICAiY2FsY3MiOiBbXSwKICAgICAgICAgICJkaXNwbGF5TW9kZSI6ICJsaXN0IiwKICAgICAgICAgICJwbGFjZW1lbnQiOiAiYm90dG9tIgogICAgICAgIH0sCiAgICAgICAgInRvb2x0aXAiOiB7CiAgICAgICAgICAibW9kZSI6ICJzaW5nbGUiLAogICAgICAgICAgInNvcnQiOiAibm9uZSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJ0YXJnZXRzIjogWwogICAgICAgIHsKICAgICAgICAgICJkYXRhc291cmNlIjogewogICAgICAgICAgICAidHlwZSI6ICJwcm9tZXRoZXVzIiwKICAgICAgICAgICAgInVpZCI6ICJjOTd2QWRVVnoiCiAgICAgICAgICB9LAogICAgICAgICAgImV4ZW1wbGFyIjogdHJ1ZSwKICAgICAgICAgICJleHByIjogInJhdGUocmVxdWVzdHNfY291bnR7fVsxbV0pIiwKICAgICAgICAgICJpbnRlcnZhbCI6ICIiLAogICAgICAgICAgImxlZ2VuZEZvcm1hdCI6ICIiLAogICAgICAgICAgInJlZklkIjogIkEiCiAgICAgICAgfQogICAgICBdLAogICAgICAidGl0bGUiOiAi0JrQvtC70LjRh9C10YHRgtCy0L4g0LfQsNC/0YDQvtGB0L7QsiDQuiDQsdGN0LrQtdC90LTRgyAiLAogICAgICAidHlwZSI6ICJ0aW1lc2VyaWVzIgogICAgfQogIF0sCiAgInJlZnJlc2giOiAiNXMiLAogICJzY2hlbWFWZXJzaW9uIjogMzUsCiAgInN0eWxlIjogImRhcmsiLAogICJ0YWdzIjogW10sCiAgInRlbXBsYXRpbmciOiB7CiAgICAibGlzdCI6IFtdCiAgfSwKICAidGltZSI6IHsKICAgICJmcm9tIjogIm5vdy01bSIsCiAgICAidG8iOiAibm93IgogIH0sCiAgInRpbWVwaWNrZXIiOiB7fSwKICAidGltZXpvbmUiOiAiIiwKICAidGl0bGUiOiAi0J/QtdC70YzQvNC10L3QvdCw0Y8iLAogICJ1aWQiOiAiOXJmRV9kVTR6IiwKICAidmVyc2lvbiI6IDEyLAogICJ3ZWVrU3RhcnQiOiAiIgp9
